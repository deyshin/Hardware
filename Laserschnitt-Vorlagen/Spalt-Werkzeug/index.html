<html>

<head>
<script src="jQuery.js"></script>
<script src="d3.js"></script>
<style>
iframe {
    width: 90%;
    height: 90%;
    overflow: scroll;
    }
.pathPoint {
    stroke: gray;
    }
.piecePoint {
    fill: blue;
}
.slotPoint {
    fill: yellow;
}
</style>
</head>

<body>
<!--object type="image/svg+xml" id="svg" data="Pteranodon.svg"></object-->

<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   version="1.1"
   width="1346.4567"
   height="1346.4567"
   id="svg"
   inkscape:version="0.48.3.1 r9886"
   sodipodi:docname="Pteranodon.svg">
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="1280"
     inkscape:window-height="973"
     id="namedview13"
     showgrid="false"
     inkscape:zoom="0.53677925"
     inkscape:cx="676.95426"
     inkscape:cy="673.22833"
     inkscape:window-x="0"
     inkscape:window-y="0"
     inkscape:window-maximized="1"
     inkscape:current-layer="g2990" />
  <defs
     id="defs4" />
  <metadata
     id="metadata7">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title />
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <g
     transform="translate(804.78287,-577.20117)"
     id="layer1">
    <g
       id="g2990">
      <path
         d="m -355.28241,1400.193 c 19.64214,-48.6634 29.30821,-91.8392 34.09405,-152.2874 3.8635,-48.7995 9.96738,-56.1748 49.90115,-56.5717 29.20292,-0.2903 28.60532,1.4961 51.16902,-4.8014 16.98384,-4.7401 19.09896,-10.0817 23.5599,-59.4918 2.23283,-24.7289 7.34614,-79.0867 11.3631,-120.7948 4.01692,-41.70832 9.24702,-96.3439 11.62211,-121.41283 4.08106,-43.07296 4.65831,-45.73029 10.49576,-48.31804 8.48366,-3.76075 20.12867,-0.5254 22.11427,6.14381 0.88129,2.96007 9.31656,78.69834 18.74501,168.30716 18.8747,179.3876 16.68457,168.9234 34.412692,174.408 17.273703,5.344 34.330355,5.2778 52.129758,4.9952 26.5765014,-0.4219 30.7598063,0.7926 39.9736585,11.6052 6.1352915,7.1999 6.9833455,11.0181 12.6368565,56.8981 7.888321,64.0144 21.555659,115.1416 42.591269,159.3289 4.319439,9.0732 4.876148,12.8879 3.30511,22.6544 -3.695223,22.9716 -18.670303,36.9011 -43.72013,43.318 -14.0472446,3.5984 -29.757876,2.9903 -42.159609,6.4369 -18.875475,5.2458 -38.697232,-1.526 -47.292017,-16.2015 -12.612452,-21.536 -28.254876,-31.2841 -56.527818,-30.8499 -18.35759,0.2819 -36.71517,0.5638 -55.07276,0.8457 -24.95146,0.3832 -34.30128,7.5392 -48.752,27.7697 -13.04498,18.2625 -25.26147,22.9103 -43.64021,20.4246 -18.37874,-2.4857 -27.93782,-3.4927 -46.8379,-6.6461 -18.90008,-3.1534 -41.82234,-25.0766 -45.335,-41.162 -3.51266,-16.0854 5.10463,-29.4372 11.22378,-44.5982 6.11914,-15.161 -19.47042,48.2378 -5e-5,0 z"
         id="path3084"
         style="fill:none;stroke:#000000;stroke-width:2.5395" />
      <path
         style="fill:none;stroke:#ff0000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
         d="m -239.28287,1190.1578 c -2.5,27.8333 -5,55.6667 -7.5,83.5"
         id="path3026"
         inkscape:connector-curvature="0" />
      <path
         style="fill:none;stroke:#ff0000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
         d="m -69.28287,1191.1578 c 3,27.3334 6,54.6667 9,82"
         id="path3028"
         inkscape:connector-curvature="0" />
      <path
         style="fill:none;stroke:#ff0000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
         d="m -151.28287,1442.1578 c -0.5,-44.5 -1,-89 -1.5,-133.5"
         id="path3030"
         inkscape:connector-curvature="0" />
      <path
         style="fill:none;stroke:#ff0000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
         d="m -4.28287,1488.1578 c -6,-49.3333 -12,-98.6666 -18,-148"
         id="path3032"
         inkscape:connector-curvature="0" />
      <path
         style="fill:none;stroke:#ff0000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
         d="m -298.78287,1488.1578 c 5,-49.5 10,-99 15,-148.5"
         id="path3034"
         inkscape:connector-curvature="0" />
    </g>
  </g>
</svg>


<script>
// enter SVG
var svg = document.getElementById('svg');
var paths = svg.getElementsByTagName('path');

/*
 * http://stackoverflow.com/questions/9677885/convert-svg-path-to-absolute-commands
 */
function convertToAbsolute(path){
    var x0,y0,x1,y1,x2,y2,segs = path.pathSegList;
    for (var x=0,y=0,i=0,len=segs.numberOfItems;i<len;++i){
      var seg = segs.getItem(i), c=seg.pathSegTypeAsLetter;
      if (/[MLHVCSQTA]/.test(c)){
        if ('x' in seg) x=seg.x;
        if ('y' in seg) y=seg.y;
      }else{
        if ('x1' in seg) x1=x+seg.x1;
        if ('x2' in seg) x2=x+seg.x2;
        if ('y1' in seg) y1=y+seg.y1;
        if ('y2' in seg) y2=y+seg.y2;
        if ('x'  in seg) x+=seg.x;
        if ('y'  in seg) y+=seg.y;
        switch(c){
          case 'm': segs.replaceItem(path.createSVGPathSegMovetoAbs(x,y),i);                   break;
          case 'l': segs.replaceItem(path.createSVGPathSegLinetoAbs(x,y),i);                   break;
          case 'h': segs.replaceItem(path.createSVGPathSegLinetoHorizontalAbs(x),i);           break;
          case 'v': segs.replaceItem(path.createSVGPathSegLinetoVerticalAbs(y),i);             break;
          case 'c': segs.replaceItem(path.createSVGPathSegCurvetoCubicAbs(x,y,x1,y1,x2,y2),i); break;
          case 's': segs.replaceItem(path.createSVGPathSegCurvetoCubicSmoothAbs(x,y,x2,y2),i); break;
          case 'q': segs.replaceItem(path.createSVGPathSegCurvetoQuadraticAbs(x,y,x1,y1),i);   break;
          case 't': segs.replaceItem(path.createSVGPathSegCurvetoQuadraticSmoothAbs(x,y),i);   break;
          case 'a': segs.replaceItem(path.createSVGPathSegArcAbs(x,y,seg.r1,seg.r2,seg.angle,seg.largeArcFlag,seg.sweepFlag),i);   break;
          case 'z': case 'Z': x=x0; y=y0; break;
        }
      }
      // Record the start of a subpath
      if (c=='M' || c=='m') x0=x, y0=y;
    }
  }

addPathPointRects = function(path, prefixId, addClass) {
    for (var i=0; i<path.pathSegList.numberOfItems; ++i){
        var segment = path.pathSegList.getItem(i);
//        console.log(i+': ');
//        console.log(segment);
        if (segment.pathSegType != SVGPathSeg.PATHSEG_CLOSEPATH)
            d3.select('#g2990')
                .append('rect')
                    .attr("id", prefixId+i)
                    .attr("class", "pathPoint "+addClass)
                    .attr("x", parseFloat(segment.x)-4)
                    .attr("y", parseFloat(segment.y)-4)
                    .attr("width", 8)
                    .attr("height", 8)
                    .attr("tooltip", i);
    }
}

// discriminate between piece and slot paths
piece = null;
slots = []; 
for (var i=0; i<paths.length; i++) {
    convertToAbsolute(paths[i]);
    if (paths[i].pathSegList.numberOfItems > 2) {
        piece = paths[i];
    } else {
        slots.push(paths[i]);
    }
}

// draw some Inkscape-like rectangles to show where the path points are 
addPathPointRects(piece, 'piecePoint', 'piecePoint');
for (var i=0; i<slots.length; i++)
    addPathPointRects(slots[i], 'slotPoint'+i+'_', 'slotPoint');

console.log('Slots: '+slots.length);
console.log(slots);
console.log('Piece: ');
console.log(piece);


/*
 * for every slot:
 * identify the affected piece segment
 * create a slot segment from slot path
 * replace piece segment by slot segment
 * remove slot path
 */

calcDistance = function(A, B) {
    return Math.sqrt( Math.pow(B.x-A.x,2) + Math.pow(B.y-A.y,2) );
}

findPieceSlotIntersection = function(piece, slot) {
    
    // get slot dimensions
    var slotFrom = slot.pathSegList.getItem(0);
    var slotTo = slot.pathSegList.getItem(1);
    var slotWidth = 20;
    
    var pointBeforeIndex = pointAfterIndex = null;
    var minDistance1 = minDistance2 = piece.getTotalLength(); // maximum possible distance
    var minDistancePointIndex1 = minDistancePointIndex2 = null;
    for (var i=0; i<piece.pathSegList.numberOfItems; ++i){
        var segment = piece.pathSegList.getItem(i);
        if (segment.pathSegType == SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS) {
            var distance = calcDistance(segment, slotFrom);
//            console.log(i+': '+distance)
            if (distance < minDistance1) {
                minDistance2 = minDistance1;
                minDistancePointIndex2 = minDistancePointIndex1;
                minDistance1 = distance;
                minDistancePointIndex1 = i;
            } else if (distance < minDistance2) {
                minDistance2 = distance;
                minDistancePointIndex2 = i;
            }
        }
    }
    if (minDistancePointIndex2 < minDistancePointIndex1) // then swap variables
        minDistancePointIndex2 = [minDistancePointIndex1, minDistancePointIndex1 = minDistancePointIndex2][0];
    
    // highlight intersection
    $('#piecePoint'+minDistancePointIndex1).css('fill', 'red');
    $('#piecePoint'+minDistancePointIndex2).css('fill', 'red');
    
    return minDistancePointIndex1;
 }

for (var i=0; i<slots.length; i++) {
    console.log('Piece path intersection of slot '+i+':');
    var a = findPieceSlotIntersection(piece, slots[i]);
    var b = a+1;
    console.log(a+' - '+b);
    
    var A = slots[i].pathSegList.getItem(1);
    var slotSegment = piece.createSVGPathSegLinetoAbs( A.x, A.y );
    piece.pathSegList.insertItemBefore(slotSegment, b);
    
    // remove slot path
    //slots[i].parentNode.removeChild(slots[i]);
}
</script>

</body>

</html>